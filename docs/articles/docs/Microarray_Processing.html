<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Data Acquisition and ExpressionSet Basics • BS831</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<script src="../../extra.js"></script><meta property="og:title" content="Data Acquisition and ExpressionSet Basics">
<meta property="og:description" content="BS831">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">BS831</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.20.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Markdowns
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Introduction to Genomics Analysis</li>
    <li>
      <a href="../../articles/docs/matrixOp.html">Efficient Computation in R</a>
    </li>
    <li>
      <a href="../../articles/docs/ExpressionSet.html">The ExpressionSet Data Object</a>
    </li>
    <li>
      <a href="../../articles/docs/Distributions.html">Probability Distributions</a>
    </li>
    <li>
      <a href="../../articles/docs/Mix_Normals.html">Mixture of Normals</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Preprocessing and Quality Control</li>
    <li>
      <a href="../../articles/docs/Microarray_Processing.html">Data Acquisition and ExpressionSet Basics</a>
    </li>
    <li>
      <a href="../../articles/docs/microarrayQC.html">Quality Control</a>
    </li>
    <li>
      <a href="../../articles/docs/Dimensionality_Reduction.html">Dimensionality Reduction</a>
    </li>
    <li>
      <a href="../../articles/docs/Heatmaps.html">Heatmaps</a>
    </li>
    <li>
      <a href="../../articles/docs/hclust.html">Hierarchical Clustering</a>
    </li>
    <li>
      <a href="../../articles/docs/quantileNormalization.html">Quantile Normalization</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Comparative Experiments I: Microarrays and Linear Models</li>
    <li>
      <a href="../../articles/docs/SampleSize.html">Sample Size and Statistical Significance</a>
    </li>
    <li>
      <a href="../../articles/docs/MHTcorrection.html">Multiple-Hypothesis Correction</a>
    </li>
    <li>
      <a href="../../articles/docs/Linear_Regression.html">Linear Regression</a>
    </li>
    <li>
      <a href="../../articles/docs/diffanalLM.html">Differential Analysis as Linear Regression</a>
    </li>
    <li>
      <a href="../../articles/docs/Diffanalysis.html">Gene Expression Differential Analysis with Microarrays</a>
    </li>
    <li>
      <a href="../../articles/docs/Diffanal_LimmaBC.html">Gene Expression Differential Analysis based on Limma</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Comparative Experiments II: RNA-seq and Generalized Lineary Models</li>
    <li>
      <a href="../../articles/docs/RNAseq_ScalNorm.html">RNA-Seq Data Scaling and Normalization</a>
    </li>
    <li>
      <a href="../../articles/docs/DiffanalysisRNAseqComparison.html">RNA-seq Differential Expression Analysis with DEseq2, edgeR and limma</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Comparative Experiments III: Differential Enrichment Analysis</li>
    <li>
      <a href="../../articles/docs/HyperEnrichment.html">HyperGeometric Enrichment</a>
    </li>
    <li>
      <a href="../../articles/docs/KS_Enrichment.html">KS-based Enrichment</a>
    </li>
    <li>
      <a href="../../articles/docs/GeneSetProjectionGSVA.html">Gene Set Projection based on KS</a>
    </li>
    <li>
      <a href="../../articles/docs/GeneSetProjectionASSIGN.html">Geneset projection based on ASSIGN</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Classification</li>
    <li>
      <a href="../../articles/docs/featureRedundancy.html">Feature Redundancy: the Good and the Bad</a>
    </li>
    <li>
      <a href="../../articles/docs/Classification_Caret.html">Classification Using Caret</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Clustering</li>
    <li>
      <a href="../../articles/docs/GenesetMapping4KS.html">Mapping genesets for KS testing</a>
    </li>
    <li>
      <a href="../../articles/docs/Clustering.html">Clustering and Heatmap Visualization</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/montilab/BS831">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Data Acquisition and ExpressionSet Basics</h1>
                        <h4 class="author">Anthony Federico, Stefano Monti</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/montilab/BS831/blob/master/vignettes/docs/Microarray_Processing.Rmd"><code>vignettes/docs/Microarray_Processing.Rmd</code></a></small>
      <div class="hidden name"><code>Microarray_Processing.Rmd</code></div>

    </div>

    
    
<p>In this module, we illustrate how to download gene expression datasets from <a href="http://www.ncbi.nlm.nih.gov/geo">GEO</a>.</p>
<p>To this end, we will download and pre-process the gene expression data from the LOAD (Late Onset Alzheimer Disease) study in <a href="http://www.cell.com/fulltext/S0092-8674(13)00387-5"> [Zhang et al., Cell 2013] </a>. The dataset consists of gene expression data of postmortem brain tissues from three brain regions (PC: prefrontal cortex; VC: visual cortex; and CB: cerebellum) from 129 LOAD patients and 101 healthy controls for a total of 690 profiles.</p>
<p>We start by loading some required packages and functions.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">BS831</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">GEOquery</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">Biobase</span>)
<span class="no">overwrite</span> <span class="kw">&lt;-</span> <span class="fl">FALSE</span></pre></body></html></div>
<div id="download-data-from-geo" class="section level1">
<h1 class="hasAnchor">
<a href="#download-data-from-geo" class="anchor"></a>Download data from GEO</h1>
<p>We start by downloading the data from GEO. We will then show two approaches to adding gene annotation to the expression matrix, one based on the use of already available annotation available on GEO, and another one based on “de-novo” annotation based on the <code>biomaRt</code> package.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co">## Download expression data from GEO and store in temporary directory</span>
<span class="no">tmp_dir</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>()
<span class="no">LOAD</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GEOquery/man/getGEO.html">getGEO</a></span>(<span class="kw">GEO</span><span class="kw">=</span><span class="st">"GSE44772"</span>, <span class="kw">GSEMatrix</span><span class="kw">=</span><span class="fl">TRUE</span>, <span class="kw">destdir</span><span class="kw">=</span><span class="no">tmp_dir</span>)
<span class="no">LOAD</span> <span class="kw">&lt;-</span> <span class="no">LOAD</span><span class="kw">[[</span><span class="fl">1</span>]] <span class="co"># getGEO returns a list, so we extract the first element</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">LOAD</span>)       <span class="co"># display summary info for the object</span></pre></body></html></div>
<pre><code>## ExpressionSet (storageMode: lockedEnvironment)
## assayData: 39280 features, 690 samples 
##   element names: exprs 
## protocolData: none
## phenoData
##   sampleNames: GSM1090267 GSM1090268 ... GSM1090960 (690 total)
##   varLabels: title geo_accession ... tissue:ch2 (66 total)
##   varMetadata: labelDescription
## featureData
##   featureNames: 10019475365 10019481149 ... 10033669049 (39280 total)
##   fvarLabels: ID EntrezGeneID ... RosettaGeneModelID (7 total)
##   fvarMetadata: Column Description labelDescription
## experimentData: use 'experimentData(object)'
##   pubMedIds: 23622250 
## Annotation: GPL4372</code></pre>
<div id="use-pre-existing-gene-annotation" class="section level2">
<h2 class="hasAnchor">
<a href="#use-pre-existing-gene-annotation" class="anchor"></a>Use pre-existing Gene Annotation</h2>
<p>We first show how to use already available gene annotation information. To this end, we manually downloaded to the data/ subfolder the <a href="https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GPL4372">GPL4372.annot</a> file from geo, then ran the following command.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co">## read.delim can read compressed files</span>
<span class="no">fdata</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.delim</a></span>(<span class="kw">file</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span>(<span class="st">"extdata"</span>, <span class="kw">package</span><span class="kw">=</span><span class="st">"BS831"</span>), <span class="st">"GPL4372.annot"</span>), <span class="kw">skip</span><span class="kw">=</span><span class="fl">27</span>,<span class="kw">row.names</span><span class="kw">=</span><span class="fl">1</span>)
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>))</pre></body></html></div>
<pre><code>##  [1] "Gene.title"            "Gene.symbol"           "Gene.ID"              
##  [4] "UniGene.title"         "UniGene.symbol"        "UniGene.ID"           
##  [7] "Nucleotide.Title"      "GI"                    "GenBank.Accession"    
## [10] "Platform_CLONEID"      "Platform_ORF"          "Platform_SPOTID"      
## [13] "Chromosome.location"   "Chromosome.annotation" "GO.Function"          
## [16] "GO.Process"            "GO.Component"          "GO.Function.ID"       
## [19] "GO.Process.ID"         "GO.Component.ID"</code></pre>
<p>There are many more annotation columns than needeed, thus we extract some relevant columns, and since we are at it, we also properly sort the rows, and rename the columns, for easier handling.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co">## see R/misc.R for a definition of the 'match.nona' function</span>
<span class="no">fdata</span> <span class="kw">&lt;-</span> <span class="no">fdata</span>[<span class="fu">match.nona</span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html">featureNames</a></span>(<span class="no">LOAD</span>),<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">fdata</span>)),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Gene.symbol"</span>,<span class="st">"Gene.title"</span>,<span class="st">"Gene.ID"</span>)]
<span class="co">## modifying fdata colnames for ease of handling</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"Gene.symbol"</span>,<span class="st">"gene_symbol"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"Gene.title"</span>,<span class="st">"gene_title"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>))
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">gsub</a></span>(<span class="st">"Gene.ID"</span>,<span class="st">"GeneID"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">fdata</span>))

<span class="co">## always be super-cautious, double- and triple-check</span>
<span class="kw">if</span> ( <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html">featureNames</a></span>(<span class="no">LOAD</span>)<span class="kw">!=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">fdata</span>)) ) <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>( <span class="st">"row mismatch"</span> )

<span class="co">## finally, update the gene annotation in the ExpressionSet</span>
<span class="no">LOAD1</span> <span class="kw">&lt;-</span> <span class="no">LOAD</span>
<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD1</span>) <span class="kw">&lt;-</span> <span class="no">fdata</span>

<span class="co">## save data</span>
<span class="kw">if</span> (<span class="no">overwrite</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">LOAD1</span>, <span class="kw">file</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">OMPATH</span>,<span class="st">"data/LOAD1.RDS"</span>))
}</pre></body></html></div>
</div>
<div id="gene-annotation-based-on-biomart" class="section level2">
<h2 class="hasAnchor">
<a href="#gene-annotation-based-on-biomart" class="anchor"></a>Gene Annotation based on <code>biomaRt</code>
</h2>
<p>We will use the <code>EntrezGeneID</code> column in the fData to retrieve gene symbols and descriptions with <code>biomaRt</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co">## check the annotation columns in fData</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD</span>)))</pre></body></html></div>
<pre><code>## [1] "ID"                            "EntrezGeneID"                 
## [3] "ORF"                           "GB_ACC"                       
## [5] "PROBE_DERIVED_FROM_TRANSCRIPT" "SPOT_ID"                      
## [7] "RosettaGeneModelID"</code></pre>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="co">## we first restrict to rows w/ non-empty EntrezGeneID annotation</span>
<span class="no">LOAD</span> <span class="kw">&lt;-</span> <span class="no">LOAD</span>[!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD</span>)[,<span class="st">"EntrezGeneID"</span>]),]; <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LOAD</span>)</pre></body></html></div>
<pre><code>## Features 
##    25929</code></pre>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="co">## notice that there are replicate entries, but we will deal with them later</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>( <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD</span>)[,<span class="st">"EntrezGeneID"</span>])) )</pre></body></html></div>
<pre><code>## [1] 21576</code></pre>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co">## use biomaRt databased to retrieve the relevant annotation (type</span>
<span class="co">## `?useMart` and `?getBM` for details)</span>
<span class="no">mart</span> <span class="kw">&lt;-</span> <span class="kw pkg">biomaRt</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/biomaRt/man/useMart.html">useMart</a></span>(<span class="kw">biomart</span><span class="kw">=</span><span class="st">"ensembl"</span>, <span class="kw">dataset</span><span class="kw">=</span><span class="st">"hsapiens_gene_ensembl"</span>)
<span class="no">martMap</span> <span class="kw">&lt;-</span> <span class="kw pkg">biomaRt</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/biomaRt/man/getBM.html">getBM</a></span>(<span class="kw">attributes</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"entrezgene_id"</span>,<span class="st">"hgnc_symbol"</span>,<span class="st">"description"</span>),
                          <span class="kw">filters</span><span class="kw">=</span><span class="st">"entrezgene_id"</span>,
                          <span class="kw">values</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD</span>)[,<span class="st">"EntrezGeneID"</span>],
                          <span class="kw">mart</span><span class="kw">=</span><span class="no">mart</span>)

<span class="co">## remove entries with empty gene symbol</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">martMap</span>) <span class="co"># before</span></pre></body></html></div>
<pre><code>## [1] 22183</code></pre>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">martMap</span> <span class="kw">&lt;-</span> <span class="no">martMap</span>[<span class="no">martMap</span>[,<span class="st">"hgnc_symbol"</span>]<span class="kw">!=</span><span class="st">""</span>,]
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">martMap</span>) <span class="co"># after</span></pre></body></html></div>
<pre><code>## [1] 22060</code></pre>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="co">## notice that there are some duplicated entrez IDs and gene symbols</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span>(<span class="no">martMap</span>[,<span class="st">"entrezgene_id"</span>]))</pre></body></html></div>
<pre><code>## [1] 3920</code></pre>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span>(<span class="no">martMap</span>[,<span class="st">"hgnc_symbol"</span>]))</pre></body></html></div>
<pre><code>## [1] 3920</code></pre>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="co">## we adopt the simple (perhaps too simple) approach of taking the</span>
<span class="co">## first occurence of each EntrezID</span>
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">martMap</span>)</pre></body></html></div>
<pre><code>## [1] 22060</code></pre>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">martMap</span> <span class="kw">&lt;-</span> <span class="no">martMap</span>[<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">martMap</span>[,<span class="st">"entrezgene_id"</span>]),<span class="no">martMap</span>[,<span class="st">"entrezgene_id"</span>]),]
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">martMap</span>)</pre></body></html></div>
<pre><code>## [1] 18140</code></pre>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="co">## now there are no more replicated EntrezID (but there are still replicate gene symbols)</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span>(<span class="no">martMap</span>[,<span class="st">"entrezgene_id"</span>]))</pre></body></html></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw pkg">base</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span>(<span class="no">martMap</span>[,<span class="st">"hgnc_symbol"</span>]))</pre></body></html></div>
<pre><code>## [1] 27</code></pre>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="co">## let us now match gene annotation and expression data</span>
<span class="no">matchIdx</span> <span class="kw">&lt;-</span> <span class="fu">match.nona</span>( <span class="no">martMap</span>[,<span class="st">"entrezgene_id"</span>], <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD</span>)[,<span class="st">"EntrezGeneID"</span>] )
<span class="no">LOAD2</span> <span class="kw">&lt;-</span> <span class="no">LOAD</span>[<span class="no">matchIdx</span>,]
<span class="kw">if</span> ( <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="no">martMap</span>[,<span class="st">"entrezgene_id"</span>]<span class="kw">!=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD2</span>)[,<span class="st">"EntrezGeneID"</span>]) ) <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>( <span class="st">"row mismatch"</span> )
<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">LOAD2</span>) <span class="kw">&lt;-</span> <span class="no">martMap</span>

<span class="co">## save data</span>
<span class="kw">if</span> (<span class="no">overwrite</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>( <span class="no">LOAD2</span>, <span class="kw">file</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">OMPATH</span>,<span class="st">"data/LOAD2.RDS"</span>) )
}</pre></body></html></div>
</div>
<div id="merge-replicated-entries" class="section level2">
<h2 class="hasAnchor">
<a href="#merge-replicated-entries" class="anchor"></a>Merge Replicated Entries</h2>
<p>This next step is not necessary, as one might want to keep the multiple chip probes associated with the same gene symbol separate until the end of the analysis. However, if desired, one can merge the rows corresponding to multiple probes.</p>
<p>Here, we define a simple function to collapse multiple rows by median. The function is based on the R functions <code>melt</code> and <code>dcast</code> defined in the package <code>reshape2</code>.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="no">reshape2</span>)
<span class="no">collapseByMedian</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">eset</span>, <span class="no">rowid</span>)
{
    <span class="co">## require(reshape2)</span>

    <span class="co">## remove unmapped probe sets</span>
    <span class="no">genes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">eset</span>)[, <span class="no">rowid</span>]
    <span class="no">rows.mapped</span> <span class="kw">&lt;-</span> !<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">genes</span>) <span class="kw">&amp;</span> <span class="no">genes</span> <span class="kw">!=</span> <span class="st">""</span>
    <span class="no">eset</span> <span class="kw">&lt;-</span> <span class="no">eset</span>[<span class="no">rows.mapped</span>,]
    <span class="no">genes</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">eset</span>)[, <span class="no">rowid</span>]

    <span class="co">## collapse by median value among duplicate probes</span>
    <span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html">exprs</a></span>(<span class="no">eset</span>), <span class="kw">genes</span> <span class="kw">=</span> <span class="no">genes</span>)
    <span class="no">df.melt</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="no">df</span>, <span class="kw">id.vars</span> <span class="kw">=</span> <span class="st">"genes"</span>)
    <span class="no">df.median.collapsed</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/cast.html">dcast</a></span>(<span class="no">df.melt</span>, <span class="no">genes</span> ~ <span class="no">variable</span>, <span class="no">median</span>)

    <span class="co">## reassemble collapsed eset</span>
    <span class="no">fdat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">eset</span>)
    <span class="kw">if</span> ( <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">roworder</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="no">df.median.collapsed</span>[,<span class="st">'genes'</span>],<span class="no">fdat</span>[,<span class="no">rowid</span>]))) )
        <span class="fu"><a href="https://rdrr.io/r/base/stop.html">stop</a></span>( <span class="st">"something wrong"</span> )
    <span class="no">fdat.collapsed</span> <span class="kw">&lt;-</span> <span class="no">fdat</span>[<span class="no">roworder</span>,]
    <span class="no">eset</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/class.ExpressionSet.html">ExpressionSet</a></span>(<span class="kw">assayData</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">df.median.collapsed</span>[, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">eset</span>)]),
                          <span class="kw">phenoData</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/class.AnnotatedDataFrame.html">AnnotatedDataFrame</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/phenoData.html">pData</a></span>(<span class="no">eset</span>)),
                          <span class="kw">featureData</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/class.AnnotatedDataFrame.html">AnnotatedDataFrame</a></span>(<span class="no">fdat.collapsed</span>))
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">eset</span>)
}
<span class="no">collapseByFun</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">eset</span>,<span class="no">rowid</span>,<span class="no">method</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"median"</span>,<span class="st">"mean"</span>))
{
    <span class="no">tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">key</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">eset</span>)[,<span class="no">rowid</span>],
                      <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/exprs.html">exprs</a></span>(<span class="no">eset</span>))
    <span class="no">tbl1</span> <span class="kw">&lt;-</span> <span class="no">tbl</span> <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">key</span>) <span class="kw">%&gt;%</span> <span class="fu">summarize_all</span>(<span class="no">median</span>)

    <span class="no">dat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(<span class="no">tbl1</span>[,-<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="st">"key"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">tbl1</span>))])
    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">dat</span>) <span class="kw">&lt;-</span> <span class="no">tbl1</span>[,<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="st">"key"</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">tbl1</span>))]

    <span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/class.ExpressionSet.html">ExpressionSet</a></span>(<span class="kw">assayData</span><span class="kw">=</span><span class="no">dat</span>,
                  <span class="kw">phenoData</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/phenoData.html">pData</a></span>(<span class="no">eset</span>)[,<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="no">dat</span>),<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureNames.html">sampleNames</a></span>(<span class="no">eset</span>))],
                  <span class="kw">featureData</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">eset</span>)[<span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="no">dat</span>),<span class="fu"><a href="https://rdrr.io/pkg/Biobase/man/featureData.html">fData</a></span>(<span class="no">eset</span>)[,<span class="no">rowid</span>]),])

}</pre></body></html></div>
<p>We now apply <code>collapseByMedian</code> to both LOAD1 (n=19756 duplicates), and LOAD2 (n=27 duplicates). Notice that running it on a 600+ sample size is somewhat slow.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LOAD1</span>)
<span class="no">LOAD1.collapsed</span> <span class="kw">&lt;-</span> <span class="fu">collapseByMedian</span>(<span class="no">LOAD1</span>, <span class="kw">rowid</span><span class="kw">=</span><span class="st">"gene_symbol"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LOAD1.collapsed</span>)
<span class="kw">if</span> (<span class="no">overwrite</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">LOAD1.collapsed</span>,<span class="kw">file</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">OMPATH</span>,<span class="st">"data/LOAD1.collapsed.RDS"</span>))
}
<span class="no">tbl</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">key</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"a"</span>,<span class="st">"b"</span>,<span class="st">"a"</span>,<span class="st">"b"</span>),<span class="kw">col1</span><span class="kw">=</span><span class="fl">1</span>:<span class="fl">4</span>,<span class="kw">col2</span><span class="kw">=</span><span class="fl">5</span>:<span class="fl">8</span>)</pre></body></html></div>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LOAD2</span>)
<span class="no">LOAD2.collapsed</span> <span class="kw">&lt;-</span> <span class="fu">collapseByMedian</span>(<span class="no">LOAD2</span>, <span class="kw">rowid</span><span class="kw">=</span><span class="st">"hgnc_symbol"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">LOAD2.collapsed</span>)
<span class="kw">if</span> (<span class="no">overwrite</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span>(<span class="no">LOAD2.collapsed</span>,<span class="kw">file</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">OMPATH</span>,<span class="st">"data/LOAD2.collapsed.RDS"</span>))
}</pre></body></html></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/tetomonti">Stefano Monti</a>, <a href="https://github.com/anfederico">Anthony Federico</a>, <a href="https://github.com/ericreed">Eric Reed</a>, <a href="https://github.com/lia978">Amy Li</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
